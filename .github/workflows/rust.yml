# .github/workflows/rust.yml
name: Rust
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  release:
    types: [ created ]

env:
  CARGO_TERM_COLOR: always

# -------------------------------------------------
# Existing desktop / MSRV jobs (unchanged)
# -------------------------------------------------
jobs:
  build:
    name: Build with latest stable Rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Install dependencies
        run: sudo apt-get update && sudo apt install libdbus-1-dev pkg-config
      - name: Install latest stable Rust
        run: rustup set profile default && rustup default stable && rustup update && rustup target add wasm32-unknown-unknown
      - name: Check code formatting
        run: cargo fmt -- --check
      - name: Build
        run: cargo build --features bluer,usb-device,usb-host,raw-speed-cli,dump --all-targets --quiet
      - name: Build aggligator-transport-webusb
        run: cd aggligator-transport-webusb && cargo build --quiet
      - name: Build aggligator-transport-websocket-web
        run: cd aggligator-transport-websocket-web && cargo build --quiet
      - name: Build documentation
        run: cargo doc --no-deps --quiet
      - name: Code analysis
        run: cargo clippy --features bluer,usb-device,usb-host,raw-speed-cli,dump --all-targets --quiet
      - name: Run tests (debug)
        run: cargo test --quiet
      - name: Run tests (release)
        run: cargo test --release --quiet
      - name: Run agg-speed
        run: |
          cargo build --quiet --release --bin agg-speed
          RUST_LOG=info cargo run --quiet --release --bin agg-speed -- server --tls --no-monitor --oneshot &
          sleep 1
          RUST_LOG=info cargo run --quiet --release --bin agg-speed -- client --tls --no-monitor --time 15 --tcp localhost
      - name: Security vulnerability audit
        run: |
          cargo install --quiet cargo-audit
          cargo audit --quiet

  build-windows:
    name: Build with latest stable Rust on Windows
    runs-on: windows-latest
    steps:
      - uses: ilammy/setup-nasm@v1
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Install latest stable Rust
        run: rustup set profile default && rustup default stable && rustup update
      - name: Build
        run: cargo build --workspace --exclude aggligator-transport-bluer --features usb-host,raw-speed-cli,dump --all-targets --quiet
      - name: Run tests (debug)
        run: cargo test --workspace --exclude aggligator-transport-bluer --quiet

  build-msrv:
    name: Build with Rust 1.85
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Install dependencies
        run: sudo apt-get update && sudo apt install libdbus-1-dev pkg-config
      - name: Install Rust 1.85.0
        run: rustup toolchain install 1.85.0
      - name: Build aggligator and aggligator-util with Rust 1.85.0
        run: cargo +1.85.0 build --features bluer,usb-device,usb-host,raw-speed-cli,dump --all-targets --quiet

  # -------------------------------------------------
  # NEW: Android cross-compilation
  # -------------------------------------------------
  android-build:
    name: Android ${{ matrix.abi }} (API ${{ matrix.api }})
    runs-on: ubuntu-latest
    needs: build                     # optional â€“ ensures normal build passes first
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-linux-android
            abi:    arm64-v8a
            api:    android-21
          - target: armv7-linux-androideabi
            abi:    armeabi-v7a
            api:    android-21
          - target: x86_64-linux-android
            abi:    x86_64
            api:    android-21

    env:
      ANDROID_NDK_VERSION: 26.1.10909125   # bump if you need a newer NDK

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # ---- Rust + Android target ----
      - name: Install stable Rust + Android target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # ---- Cargo cache (registry + target dir) ----
      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2

      # ---- Install Android NDK ----
      - name: Install Android NDK
        uses: nttld/setup-ndk@v1
        id: ndk
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          add-to-path: false

      - name: Export NDK path
        run: echo "ANDROID_NDK_ROOT=${{ steps.ndk.outputs.ndk-path }}" >> $GITHUB_ENV

      # ---- Install cargo-ndk ----
      - name: Install cargo-ndk
        run: cargo install cargo-ndk --locked

      # ---- Build library (static + shared) ----
      - name: Build library (release)
        run: |
          cargo ndk \
            -t ${{ matrix.target }} \
            -p ${{ matrix.api }} \
            build --release --lib \
            --features bluer,usb-device,usb-host,raw-speed-cli,dump

      # ---- Build CLI binaries ----
      - name: Build agg-tunnel (release)
        run: |
          cargo ndk \
            -t ${{ matrix.target }} \
            -p ${{ matrix.api }} \
            build --release --bin agg-tunnel \
            --features bluer,usb-device,usb-host,raw-speed-cli,dump

      - name: Build agg-speed (release)
        run: |
          cargo ndk \
            -t ${{ matrix.target }} \
            -p ${{ matrix.api }} \
            build --release --bin agg-speed \
            --features bluer,usb-device,usb-host,raw-speed-cli,dump

      # ---- Gather artifacts into a per-ABI folder ----
      - name: Gather artifacts
        run: |
          mkdir -p artifacts/${{ matrix.abi }}
          cp target/${{ matrix.target }}/release/libaggligator.* artifacts/${{ matrix.abi }}/
          cp target/${{ matrix.target }}/release/agg-tunnel   artifacts/${{ matrix.abi }}/
          cp target/${{ matrix.target }}/release/agg-speed    artifacts/${{ matrix.abi }}/

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aggligator-android-${{ matrix.abi }}
          path: artifacts/${{ matrix.abi }}/*
          retention-days: 30

  # -------------------------------------------------
  # OPTIONAL: Attach Android binaries to GitHub Releases
  # -------------------------------------------------
  release-android:
    name: Publish Android binaries on tag
    needs: android-build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: android-artifacts

      - name: Create Release (or update existing)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android-artifacts/**/*.a
            android-artifacts/**/*.so
            android-artifacts/**/agg-tunnel
            android-artifacts/**/agg-speed
          draft: false
          prerelease: false
